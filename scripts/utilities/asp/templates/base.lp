% ===============================================================
%  base.lp  ―  минимальная рабочая заготовка для генератора карт
% ===============================================================
%   • рассчитана на clingo ≥ 5.4
%   • все параметры можно переопределить из GDScript
%   • собирается без ошибок:  `clingo base.lp -n 1`
% ---------------------------------------------------------------

% ---------- ГЛОБАЛЬНЫЕ КОНСТАНТЫ (можно переопределять) --------
#const w = 35.                   % ширина сетки
#const h = 20.                   % высота сетки

rooms(8).                        % сколько «центров комнат» выбрать
keys(1).                         % сколько ключей разложить

% ---------- ОБЛАСТЬ ОПРЕДЕЛЕНИЯ --------------------------------
x(0..w-1).
y(0..h-1).
cell(X,Y)     :- x(X), y(Y).

% ---------- РАСКЛАДКА КЛЕТОК (wall / floor) --------------------
{ wall(X,Y); floor(X,Y) } = 1    :- cell(X,Y).

% ---------- ВХОДЫ / ВЫХОДЫ -------------------------------------
border(X,Y)   :- floor(X,Y), (X = 0 ; X = w-1 ; Y = 0 ; Y = h-1).
1 { door(X,Y) : border(X,Y) } 2.

% ---------- «ЦЕНТРЫ» КОМНАТ ------------------------------------
{ center(X,Y) : floor(X,Y) }.
:- rooms(R), #count{ X,Y : center(X,Y) } != R.

% ---------- ДИСТАНЦИИ МЕЖДУ ЦЕНТРАМИ ---------------------------
order(X1,Y1,X2,Y2)               :- X1*100+Y1 < X2*100+Y2.

dist(X1,Y1,X2,Y2,D)              :-
    center(X1,Y1), center(X2,Y2),
    order(X1,Y1,X2,Y2),
    D = |X1-X2| + |Y1-Y2|.

% ---------- ВЫБОР РЁБЕР (приближённое MST) ---------------------
{ chosen(X1,Y1,X2,Y2) : dist(X1,Y1,X2,Y2,_) }.
:- rooms(R), R1 = R-1,
   #count{ X1,Y1,X2,Y2 : chosen(X1,Y1,X2,Y2) } != R1.

#minimize { D,X1,Y1,X2,Y2 : chosen(X1,Y1,X2,Y2), dist(X1,Y1,X2,Y2,D) }.

edge(X1,Y1,X2,Y2)                :- chosen(X1,Y1,X2,Y2).

% ---------- КЛЮЧИ ----------------------------------------------
{ key(X,Y) : center(X,Y) }.
:- keys(K), #count{ X,Y : key(X,Y) } != K.

% ---------- ЗАМКИ (приходят из GDScript как lockpair/5) --------
door(X,Y)     :- lockpair(_,X,Y,_,_).
door(X,Y)     :- lockpair(_,_,_,X,Y).

% ---------- ДОСТУПНОСТЬ ВСЕХ ПОЛОВ -----------------------------
reachable(0,0)                   :- floor(0,0).
reachable(X2,Y2)                :-
    reachable(X1,Y1), floor(X2,Y2),
    |X1-X2| + |Y1-Y2| = 1.

:- floor(X,Y), not reachable(X,Y).

% ---------- ВЫВОД ------------------------------------------------
#show wall/2.
#show floor/2.
#show door/2.
#show key/2.
#show center/2.
#show edge/4.
